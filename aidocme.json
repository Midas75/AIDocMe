{"file_name": "aidocme.py", "content": [{"level": 0, "seq": "", "doc_i": 0, "doc_type": "MODULE", "doc": "no module docs", "start": 0, "end": 8340, "doc_start": 0, "doc_end": 0, "signature": "", "title": "aidocme.py"}, {"level": 1, "seq": "1.", "doc_i": 2, "doc_type": "CLASS", "doc": "no class docs", "start": 354, "end": 418, "doc_start": 379, "doc_end": 379, "signature": "class DocType(Enum):", "title": "DocType"}, {"level": 1, "seq": "2.", "doc_i": 4, "doc_type": "CLASS", "doc": "no class docs", "start": 421, "end": 1428, "doc_start": 440, "doc_end": 440, "signature": "class Content:", "title": "Content"}, {"level": 2, "seq": "2.1.", "doc_i": 6, "doc_type": "METHOD", "doc": "no method docs", "start": 585, "end": 1077, "doc_start": 825, "doc_end": 825, "signature": "class Content:\n    def __init__(\n        self,\n        level: int,\n        doc_type: DocType,\n        doc: str,\n        start: int,\n        end: int,\n        doc_start: int,\n        doc_end: int,\n        signature: str,\n        title: str,\n    ):", "title": "__init__"}, {"level": 2, "seq": "2.2.", "doc_i": 8, "doc_type": "METHOD", "doc": "no method docs", "start": 1079, "end": 1366, "doc_start": 1118, "doc_end": 1118, "signature": "class Content:\n    def __repr__(self) -> str:", "title": "__repr__"}, {"level": 2, "seq": "2.3.", "doc_i": 10, "doc_type": "METHOD", "doc": "no method docs", "start": 1368, "end": 1428, "doc_start": 1406, "doc_end": 1406, "signature": "class Content:\n    def __str__(self) -> str:", "title": "__str__"}, {"level": 1, "seq": "3.", "doc_i": 12, "doc_type": "CLASS", "doc": "no class docs", "start": 1431, "end": 1838, "doc_start": 1451, "doc_end": 1451, "signature": "class Sequence:", "title": "Sequence"}, {"level": 2, "seq": "3.1.", "doc_i": 14, "doc_type": "METHOD", "doc": "no method docs", "start": 1470, "end": 1518, "doc_start": 1502, "doc_end": 1502, "signature": "class Sequence:\n    def __init__(self):", "title": "__init__"}, {"level": 2, "seq": "3.2.", "doc_i": 16, "doc_type": "METHOD", "doc": "no method docs", "start": 1520, "end": 1838, "doc_start": 1575, "doc_end": 1575, "signature": "class Sequence:\n    def next_seq(self, level: int = 1) -> str:", "title": "next_seq"}, {"level": 1, "seq": "4.", "doc_i": 18, "doc_type": "METHOD", "doc": "no method docs", "start": 1841, "end": 2310, "doc_start": 1929, "doc_end": 1929, "signature": "def seg_source(source: str, contents: list[Content]) -> list[tuple[int, int, str]]:", "title": "seg_source"}, {"level": 1, "seq": "5.", "doc_i": 20, "doc_type": "METHOD", "doc": "no method docs", "start": 2313, "end": 2904, "doc_start": 2444, "doc_end": 2444, "signature": "def get_docstring_range(\n    node: Module | ClassDef | FunctionDef | AsyncFunctionDef, tokens: ASTTokens\n) -> tuple[int, int]:", "title": "get_docstring_range"}, {"level": 1, "seq": "6.", "doc_i": 22, "doc_type": "METHOD", "doc": "no method docs", "start": 2907, "end": 3337, "doc_start": 2943, "doc_end": 2943, "signature": "def normalize_indent(code_str):", "title": "normalize_indent"}, {"level": 2, "seq": "6.1.", "doc_i": 24, "doc_type": "METHOD", "doc": "no method docs", "start": 3070, "end": 3262, "doc_start": 3105, "doc_end": 3105, "signature": "def normalize_indent(code_str):\n    def replace_indent(m):", "title": "replace_indent"}, {"level": 1, "seq": "7.", "doc_i": 26, "doc_type": "METHOD", "doc": "no method docs", "start": 3340, "end": 5459, "doc_start": 3482, "doc_end": 3482, "signature": "def visit(\n    node,\n    tokens: ASTTokens,\n    level: int,\n    sig_level: list[str],\n    contents: list[Content],\n    file_name: str,\n):", "title": "visit"}, {"level": 1, "seq": "8.", "doc_i": 28, "doc_type": "METHOD", "doc": "no method docs", "start": 5462, "end": 5558, "doc_start": 5514, "doc_end": 5514, "signature": "def jsonify(serialized: dict[str, Any]) -> str:", "title": "jsonify"}, {"level": 1, "seq": "9.", "doc_i": 30, "doc_type": "METHOD", "doc": "no method docs", "start": 5561, "end": 6459, "doc_start": 5617, "doc_end": 5617, "signature": "def markdownify(serialized: dict[str, Any]) -> str:", "title": "markdownify"}, {"level": 1, "seq": "10.", "doc_i": 32, "doc_type": "METHOD", "doc": "no method docs", "start": 6462, "end": 7468, "doc_start": 6603, "doc_end": 6603, "signature": "def serialize(\n    contents: list[Content],\n    seg: list[tuple[int, int, str]],\n    file_name: str = \"example.py\",\n) -> dict[str, Any]:", "title": "serialize"}, {"level": 1, "seq": "11.", "doc_i": 34, "doc_type": "METHOD", "doc": "no method docs", "start": 7471, "end": 7938, "doc_start": 7592, "doc_end": 7592, "signature": "def process(\n    filepath: str = __file__, source: str = None\n) -> tuple[list[Content], list[tuple[int, int, str]]]:", "title": "process"}, {"level": 1, "seq": "12.", "doc_i": 36, "doc_type": "METHOD", "doc": "no method docs", "start": 7941, "end": 8300, "doc_start": 7957, "doc_end": 7957, "signature": "def main():", "title": "main"}], "seg": [{"seg_start": 0, "seg_end": 0, "content": ""}, {"seg_start": 0, "seg_end": 379, "content": "from os.path import basename\nfrom pathlib import Path\nimport sys\nfrom enum import Enum\nfrom typing import Any\nfrom json import dumps\nfrom ast import (\n    parse,\n    Module,\n    get_docstring,\n    FunctionDef,\n    AsyncFunctionDef,\n    ClassDef,\n    iter_child_nodes,\n    Expr,\n    Constant,\n)\nfrom re import match, sub\nfrom asttokens import ASTTokens\n\n\nclass DocType(Enum):\n    "}, {"seg_start": 379, "seg_end": 379, "content": ""}, {"seg_start": 379, "seg_end": 440, "content": "MODULE = 0\n    METHOD = 1\n    CLASS = 2\n\n\nclass Content:\n    "}, {"seg_start": 440, "seg_end": 440, "content": ""}, {"seg_start": 440, "seg_end": 825, "content": "level: int\n    doc_type: DocType\n    doc: str\n    start: int\n    end: int\n    doc_start: int\n    doc_end: int\n    signature: str\n    title: str\n\n    def __init__(\n        self,\n        level: int,\n        doc_type: DocType,\n        doc: str,\n        start: int,\n        end: int,\n        doc_start: int,\n        doc_end: int,\n        signature: str,\n        title: str,\n    ):\n        "}, {"seg_start": 825, "seg_end": 825, "content": ""}, {"seg_start": 825, "seg_end": 1118, "content": "self.level = level\n        self.doc_type = doc_type\n        self.doc = doc\n        self.start = start\n        self.end = end\n        self.doc_start = doc_start\n        self.doc_end = doc_end\n        self.signature = signature\n        self.title = title\n\n    def __repr__(self) -> str:\n        "}, {"seg_start": 1118, "seg_end": 1118, "content": ""}, {"seg_start": 1118, "seg_end": 1406, "content": "return str(\n            [\n                self.level,\n                self.doc_type,\n                self.doc,\n                self.start,\n                self.end,\n                self.signature,\n                self.title,\n            ]\n        )\n\n    def __str__(self) -> str:\n        "}, {"seg_start": 1406, "seg_end": 1406, "content": ""}, {"seg_start": 1406, "seg_end": 1451, "content": "return self.__repr__()\n\n\nclass Sequence:\n    "}, {"seg_start": 1451, "seg_end": 1451, "content": ""}, {"seg_start": 1451, "seg_end": 1502, "content": "number: list[int]\n\n    def __init__(self):\n        "}, {"seg_start": 1502, "seg_end": 1502, "content": ""}, {"seg_start": 1502, "seg_end": 1575, "content": "self.number = []\n\n    def next_seq(self, level: int = 1) -> str:\n        "}, {"seg_start": 1575, "seg_end": 1575, "content": ""}, {"seg_start": 1575, "seg_end": 1929, "content": "if level < 1:\n            return \"\"\n        while len(self.number) < level:\n            self.number.append(0)\n        self.number[level - 1] += 1\n        self.number = self.number[:level]\n        return \".\".join(str(n) for n in self.number[:level] if n > 0) + \".\"\n\n\ndef seg_source(source: str, contents: list[Content]) -> list[tuple[int, int, str]]:\n    "}, {"seg_start": 1929, "seg_end": 1929, "content": ""}, {"seg_start": 1929, "seg_end": 2444, "content": "result = list[tuple[int, int, str]]()\n    last_e = 0\n    for c in contents:\n        if last_e != c.doc_start:\n            result.append((last_e, c.doc_start, source[last_e : c.doc_start]))\n        doc = source[c.doc_start : c.doc_end]\n        result.append((c.doc_start, c.doc_end, doc))\n        last_e = c.doc_end\n    result.append((last_e, -1, source[last_e:]))\n    return result\n\n\ndef get_docstring_range(\n    node: Module | ClassDef | FunctionDef | AsyncFunctionDef, tokens: ASTTokens\n) -> tuple[int, int]:\n    "}, {"seg_start": 2444, "seg_end": 2444, "content": ""}, {"seg_start": 2444, "seg_end": 2943, "content": "doc_node = None\n    if (  # dont care if node.body is not None and node.body[0] is not None\n        isinstance(node.body[0], Expr)\n        and isinstance(node.body[0].value, Constant)\n        and isinstance(node.body[0].value.value, str)\n    ):\n        doc_node = node.body[0]\n    if doc_node is None:\n        ds, _ = tokens.get_text_range(node.body[0], False)\n        de = ds\n    else:\n        ds, de = tokens.get_text_range(doc_node, False)\n    return ds, de\n\n\ndef normalize_indent(code_str):\n    "}, {"seg_start": 2943, "seg_end": 2943, "content": ""}, {"seg_start": 2943, "seg_end": 3105, "content": "lines = code_str.splitlines()\n    if not lines:\n        return code_str\n    indent_base = len(match(r\" *\", lines[0]).group())\n\n    def replace_indent(m):\n        "}, {"seg_start": 3105, "seg_end": 3105, "content": ""}, {"seg_start": 3105, "seg_end": 3482, "content": "newline = m.group(1)\n        spaces = m.group(2)\n        new_space_count = max(len(spaces) - indent_base, 0)\n        return newline + (\" \" * new_space_count)\n\n    result = sub(r\"(\\n)( *)\", replace_indent, code_str)\n    return result\n\n\ndef visit(\n    node,\n    tokens: ASTTokens,\n    level: int,\n    sig_level: list[str],\n    contents: list[Content],\n    file_name: str,\n):\n    "}, {"seg_start": 3482, "seg_end": 3482, "content": ""}, {"seg_start": 3482, "seg_end": 5514, "content": "sig = None\n    s, e = tokens.get_text_range(node)\n    if isinstance(node, (Module, ClassDef, FunctionDef, AsyncFunctionDef)):\n        d = get_docstring(node)\n        ds, de = get_docstring_range(node, tokens)\n        if isinstance(node, FunctionDef | AsyncFunctionDef | ClassDef):\n            bs, _ = tokens.get_text_range(node.body[0])\n            sig = tokens.get_text(node)[: bs - s]\n            sig = sig[: sig.rfind(\":\") + 1]\n            # sig = normalize_indent(sig).lstrip()\n    sig_level_copy = sig_level.copy()\n    if sig is not None:\n        sig_level_copy.append(sig)\n    if isinstance(node, Module):\n        contents.append(\n            Content(\n                level,\n                doc_type=DocType.MODULE,\n                doc=\"no module docs\" if d is None else d,\n                start=s,\n                end=e,\n                doc_start=ds,\n                doc_end=de,\n                signature=\"\\n\".join(sig_level_copy),\n                title=file_name,\n            )\n        )\n    elif isinstance(node, FunctionDef | AsyncFunctionDef):\n\n        contents.append(\n            Content(\n                level,\n                doc_type=DocType.METHOD,\n                doc=\"no method docs\" if d is None else d,\n                start=s,\n                end=e,\n                doc_start=ds,\n                doc_end=de,\n                signature=\"\\n\".join(sig_level_copy),\n                title=node.name,\n            )\n        )\n    elif isinstance(node, ClassDef):\n        contents.append(\n            Content(\n                level,\n                doc_type=DocType.CLASS,\n                doc=\"no class docs\" if d is None else d,\n                start=s,\n                end=e,\n                doc_start=ds,\n                doc_end=de,\n                signature=\"\\n\".join(sig_level_copy),\n                title=node.name,\n            )\n        )\n\n    for child in iter_child_nodes(node):\n        visit(child, tokens, level + 1, sig_level_copy, contents, file_name)\n\n\ndef jsonify(serialized: dict[str, Any]) -> str:\n    "}, {"seg_start": 5514, "seg_end": 5514, "content": ""}, {"seg_start": 5514, "seg_end": 5617, "content": "return dumps(serialized, ensure_ascii=False)\n\n\ndef markdownify(serialized: dict[str, Any]) -> str:\n    "}, {"seg_start": 5617, "seg_end": 5617, "content": ""}, {"seg_start": 5617, "seg_end": 6603, "content": "result_list = list[str]()\n    for content in serialized[\"content\"]:\n        result_list.append(\n            f\"{'#'*(content['level']+1)} \"\n            f\"{content['seq']} \"\n            f\"[`{content['title']}`]\"\n            f\"(range://?\"\n            f\"s={content['start']}&e={content['end']}\"\n            f\"&di={content['doc_i']}\"\n            f\"&ds={content['doc_start']}&de={content['doc_end']})\"\n        )\n        result_list.append(f\"```plaintext\\n{content['doc']}\\n```\")\n        if content[\"doc_type\"] == DocType.MODULE.name:\n            pass\n        elif content[\"doc_type\"] == DocType.METHOD.name:\n            result_list.append(f\"```python\\n{content['signature']}\\n```\")\n        elif content[\"doc_type\"] == DocType.CLASS.name:\n            result_list.append(f\"```python\\n{content['signature']}\\n```\")\n\n    return \"\\n\\n\".join(result_list)\n\n\ndef serialize(\n    contents: list[Content],\n    seg: list[tuple[int, int, str]],\n    file_name: str = \"example.py\",\n) -> dict[str, Any]:\n    "}, {"seg_start": 6603, "seg_end": 6603, "content": ""}, {"seg_start": 6603, "seg_end": 7592, "content": "result = dict[str, Any]()\n    result[\"file_name\"] = file_name\n    result[\"content\"] = list[dict]()\n    result[\"seg\"] = list[dict]()\n    seq = Sequence()\n    seg_idx = 0\n    for c in contents:\n        while seg[seg_idx][0] < c.doc_start:\n            seg_idx += 1\n        result[\"content\"].append(\n            {\n                \"level\": c.level,\n                \"seq\": seq.next_seq(c.level),\n                \"doc_i\": seg_idx,\n                \"doc_type\": c.doc_type.name,\n                \"doc\": c.doc,\n                \"start\": c.start,\n                \"end\": c.end,\n                \"doc_start\": c.doc_start,\n                \"doc_end\": c.doc_end,\n                \"signature\": c.signature,\n                \"title\": c.title,\n            }\n        )\n    for ss, se, sc in seg:\n        result[\"seg\"].append({\"seg_start\": ss, \"seg_end\": se, \"content\": sc})\n    return result\n\n\ndef process(\n    filepath: str = __file__, source: str = None\n) -> tuple[list[Content], list[tuple[int, int, str]]]:\n    "}, {"seg_start": 7592, "seg_end": 7592, "content": ""}, {"seg_start": 7592, "seg_end": 7957, "content": "contents = list[Content]()\n    if source is None:\n        with open(filepath, encoding=\"utf-8\") as f:\n            source = f.read()\n    file_name = basename(filepath)\n    tree = parse(source)\n    tokens = ASTTokens(source, tree=tree)\n    visit(tree, tokens, 0, [], contents, file_name)\n    return contents, seg_source(source, contents), file_name\n\n\ndef main():\n    "}, {"seg_start": 7957, "seg_end": 7957, "content": ""}, {"seg_start": 7957, "seg_end": -1, "content": "if len(sys.argv) > 1:\n        l, s, fn = process(sys.argv[1])\n    else:\n        l, s, fn = process()\n    ser = serialize(l, s, fn)\n    fnn = Path(fn).with_suffix(\"\")\n    with open(f\"{fnn}.md\", \"w\", encoding=\"utf-8\") as f:\n        f.write(markdownify(ser))\n    with open(f\"{fnn}.json\", \"w\", encoding=\"utf-8\") as f:\n        f.write(jsonify(ser))\n\n\nif __name__ == \"__main__\":\n    main()\n"}]}